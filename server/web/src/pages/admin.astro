---
import '../styles/global.css';
import NavBar from '../components/NavBar.astro';
import AdminDashboard from '../components/AdminDashboard.astro';
import Footer from '../components/Footer.astro';

const apiBase = import.meta.env.PUBLIC_API_BASE ?? '';
---

<html lang="en" class="dark overflow-x-hidden" data-api-base={apiBase}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Admin - Pulse Monitor</title>
  </head>
  <body class="min-h-screen overflow-x-hidden bg-[#151515] dark:bg-[#151515] bg-white text-[#f5f5f5] dark:text-[#f5f5f5] text-[#151515]">
    <div id="auth-check" class="hidden min-h-screen flex flex-col">
      <div class="px-2 sm:px-4 md:px-6 animate-navbar">
        <NavBar isAdmin={true} />
      </div>
      <main class="flex-1 px-2 sm:px-4 md:px-6 pt-2 sm:pt-3 pb-4 sm:pb-6 animate-content">
        <AdminDashboard apiBase={apiBase} />
      </main>
      <Footer />
    </div>
    <div id="login-redirect" class="min-h-screen flex items-center justify-center">
      <div class="text-center animate-page-in">
        <div class="w-8 h-8 border-2 border-[#404040] dark:border-[#404040] border-[#a3a3a3] border-t-transparent dark:border-t-transparent rounded-full animate-spin-smooth mx-auto mb-4"></div>
        <p class="text-sm text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252]">Checking authentication...</p>
      </div>
    </div>
  </body>
</html>

<script>
  // Get API base URL - same logic as LoginForm
  function getApiBase() {
    const root = document.documentElement;
    if (root?.dataset?.apiBase && root.dataset.apiBase.trim() !== '') {
      return root.dataset.apiBase.trim();
    }
    // Use current origin (works with nginx reverse proxy)
    return window.location.origin;
  }
  
  const apiBase = getApiBase();
  
  // Check authentication on page load
  (async () => {
    const authCheck = document.getElementById('auth-check');
    const loginRedirect = document.getElementById('login-redirect');
    
    // First check if password is set - if not, allow access to setup
    try {
      const statusRes = await fetch(`${apiBase}/api/auth/status`);
      if (statusRes.ok) {
        const statusData = await statusRes.json();
        if (!statusData.set) {
          // Password not set yet, redirect to login to set it up
          window.location.href = '/login';
          return;
        }
      }
    } catch (err) {
      // Continue with token check
    }
    
    // Get stored token
    const token = localStorage.getItem('admin_auth_token');
    
    if (!token) {
      // No token, redirect to login
      window.location.href = '/login';
      return;
    }
    
    // Verify token
    try {
      const res = await fetch(`${apiBase}/api/auth/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      
      if (res.ok) {
        const data = await res.json();
        if (data.valid) {
          // Token is valid, show admin page
          authCheck.classList.remove('hidden');
          loginRedirect.classList.add('hidden');
          
          // Set token in all API requests
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const [url, options = {}] = args;
            if (typeof url === 'string' && (url.startsWith(apiBase) || url.startsWith('/api/'))) {
              options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
              };
            }
            return originalFetch.apply(this, [url, options]);
          };
        } else {
          // Token is invalid, redirect to login
          localStorage.removeItem('admin_auth_token');
          window.location.href = '/login';
        }
      } else {
        // Verification failed, redirect to login
        localStorage.removeItem('admin_auth_token');
        window.location.href = '/login';
      }
    } catch (err) {
      localStorage.removeItem('admin_auth_token');
      window.location.href = '/login';
    }
  })();
</script>
