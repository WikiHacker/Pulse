---
import '../styles/global.css';
import LoginForm from '../components/LoginForm.astro';

const apiBase = import.meta.env.PUBLIC_API_BASE ?? '';
---

<html lang="en" data-api-base={apiBase}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Login - Pulse Monitor</title>
    <!-- Initialize language and theme before page render to prevent FOUC -->
    <script is:inline>
      (function() {
        // Get system language (convert to 'zh' or 'en')
        function getSystemLanguage() {
          const sysLang = navigator.language || (navigator.languages && navigator.languages[0]) || 'en';
          // Check if system language is Chinese (zh, zh-CN, zh-TW, etc.)
          if (sysLang.toLowerCase().startsWith('zh')) {
            return 'zh';
          }
          return 'en';
        }
        
        // Get system theme
        function getSystemTheme() {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        }
        
        // Get language preference (use system language as default)
        const storedLang = localStorage.getItem('preferred-language');
        const lang = storedLang || getSystemLanguage();
        document.documentElement.lang = lang;
        
        // Get theme preference (use system theme as default)
        const storedTheme = localStorage.getItem('preferred-theme');
        const theme = (storedTheme === 'dark' || storedTheme === 'light') ? storedTheme : getSystemTheme();
        
        // Apply theme immediately to html
        const html = document.documentElement;
        if (theme === 'dark') {
          html.classList.add('dark');
          html.classList.remove('light');
        } else {
          html.classList.add('light');
          html.classList.remove('dark');
        }
        
        // Apply theme to body when it's available
        function applyThemeToBody() {
          const body = document.body;
          if (body) {
            if (theme === 'dark') {
              body.classList.add('dark');
              body.classList.remove('light');
            } else {
              body.classList.add('light');
              body.classList.remove('dark');
            }
          } else {
            // Body not ready yet, try again
            requestAnimationFrame(applyThemeToBody);
          }
        }
        applyThemeToBody();
        
        // Preload navbar config and update page title & favicon
        const apiBase = window.location.origin;
        fetch(`${apiBase}/api/navbar/config`)
          .then(res => res.ok ? res.json() : null)
          .then(config => {
            if (config) {
              // Update page title with navbar text
              if (config.text) {
                document.title = `Login - ${config.text}`;
              }
              // Update favicon with custom logo
              if (config.logo) {
                const favicon = document.querySelector('link[rel="icon"]');
                if (favicon) {
                  favicon.href = config.logo;
                  // Auto-detect image type based on URL extension
                  const ext = config.logo.toLowerCase().split('.').pop().split('?')[0];
                  if (ext === 'svg') {
                    favicon.type = 'image/svg+xml';
                  } else if (ext === 'png') {
                    favicon.type = 'image/png';
                  } else if (ext === 'jpg' || ext === 'jpeg') {
                    favicon.type = 'image/jpeg';
                  } else if (ext === 'ico') {
                    favicon.type = 'image/x-icon';
                  } else {
                    // Remove type attribute to let browser auto-detect
                    favicon.removeAttribute('type');
                  }
                }
              }
            }
          })
          .catch(() => {
            // Silently fail, use default title
          });
      })();
    </script>
    <!-- Load custom CSS and JS from backend (all users see it) -->
    <script is:inline>
      (function() {
        // Use synchronous XMLHttpRequest to load config BEFORE page renders
        // This ensures external scripts load early enough for DOMContentLoaded
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', '/api/navbar/config', false); // false = synchronous
          xhr.send();
          
          if (xhr.status === 200) {
            var config = JSON.parse(xhr.responseText);
            
            // Inject CSS if exists
            if (config.custom_css && config.custom_css.trim()) {
              var style = document.createElement('style');
              style.textContent = config.custom_css;
              document.head.appendChild(style);
            }
            
            // Inject JS if exists
            if (config.custom_js && config.custom_js.trim()) {
              var customJS = config.custom_js;
              
              // Check if it's a complete <script> tag (external or with attributes)
              var scriptTagRegex = /<script([^>]*)>([\s\S]*?)<\/script>/gi;
              var scriptMatches = [];
              var match;
              while ((match = scriptTagRegex.exec(customJS)) !== null) {
                scriptMatches.push({attrs: match[1], content: match[2]});
              }
              
              if (scriptMatches.length > 0) {
                // Has <script> tags - parse and inject each
                scriptMatches.forEach(function(scriptData) {
                  var script = document.createElement('script');
                  
                  // Check if it has src attribute (external script)
                  var srcMatch = scriptData.attrs.match(/src=["']([^"']+)["']/);
                  if (srcMatch) {
                    script.src = srcMatch[1];
                    // Force synchronous loading for external scripts
                    script.async = false;
                    script.defer = false;
                  } else if (scriptData.content.trim()) {
                    // Inline script
                    script.textContent = scriptData.content;
                  }
                  
                  if (script.src || script.textContent) {
                    document.head.appendChild(script);
                  }
                });
              } else {
                // Plain JS code without tags - inject directly
                var script = document.createElement('script');
                script.textContent = customJS;
                document.head.appendChild(script);
              }
            }
          }
        } catch (err) {
          console.warn('Failed to load custom styles:', err);
        }
      })();
    </script>
  </head>
  <body class="min-h-screen bg-[#151515] dark:bg-[#151515] bg-white text-[#f5f5f5] dark:text-[#f5f5f5] text-[#151515]">
    <LoginForm />
  </body>
</html>